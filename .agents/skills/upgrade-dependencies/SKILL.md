---
name: upgrade-dependencies
description: Upgrade npm dependencies in relewise-sdk-javascript with a safe branch and PR flow. Use when asked to refresh package versions, maintain npm dependencies, or prepare a dependency-upgrade PR for this repository. Require a Trello card URL, enforce clean-main preflight checks, create a monthly chore branch, upgrade direct dependencies across package manifests, run script-compatibility smoke checks (including client gen-api when relevant), resolve manageable compatibility fallout, run repo-aligned validation, then push and open a PR with the Trello link on the first line.
---

# Upgrade Dependencies

## Goal
Upgrade direct npm dependencies to latest stable versions for this repository and deliver a validated PR to `main`.

## Required Input
Require a Trello card URL before running upgrade work.

If the prompt does not include a Trello URL, ask for it first and do not continue until provided.

## Preflight Git Safety
Run commands from repository root.

1. Require a strict clean worktree:
```powershell
git status --porcelain
```
Abort when any output exists.

2. Ensure `origin` exists:
```powershell
git remote get-url origin
```
Abort on failure.

3. Fetch refs:
```powershell
git fetch origin --prune
```
Abort on failure.

4. Switch to `main`:
```powershell
git switch main
```
Abort if switch is not safe.

5. Fast-forward local `main`:
```powershell
git pull --ff-only origin main
```
Abort if not fast-forward or if pull fails.

Do not continue when any preflight step fails.

## Branch Creation
Use a monthly branch:

```powershell
$stamp = Get-Date -Format 'yyyyMM'
$branchName = "chore/upgrade-dependencies-$stamp"
```

Abort if branch exists locally or remotely:
```powershell
git show-ref --verify --quiet "refs/heads/$branchName"
git ls-remote --exit-code --heads origin $branchName
```

Create and switch:
```powershell
git switch -c $branchName
```

## Discover npm Manifests
Discover package manifests under `packages/`, excluding `node_modules`.

Preferred command:
```powershell
if (Get-Command rg -ErrorAction SilentlyContinue) {
    $manifestPaths = rg --files -g "packages/**/package.json" -g "!**/node_modules/**"
} else {
    $manifestPaths = Get-ChildItem -Path .\packages -Recurse -Filter package.json |
        Where-Object { $_.FullName -notmatch '\\node_modules\\' } |
        ForEach-Object { $_.FullName }
}
$manifestPaths
```

Treat each discovered manifest directory as an upgrade target.

## npm Upgrade Workflow
For each discovered manifest directory:

1. Run the upgrade loop from repository root:
```powershell
foreach ($manifestPath in $manifestPaths) {
    $packageDir = Split-Path -Parent $manifestPath
    Push-Location $packageDir
    try {
        npm install

        $packageJson = Get-Content -Raw .\package.json | ConvertFrom-Json
        $allPackages = @()
        if ($packageJson.dependencies) { $allPackages += $packageJson.dependencies.PSObject.Properties.Name }
        if ($packageJson.devDependencies) { $allPackages += $packageJson.devDependencies.PSObject.Properties.Name }
        $allPackages = $allPackages | Sort-Object -Unique

        foreach ($pkg in $allPackages) {
            Write-Host "Updating npm package $pkg in $packageDir"
            npm install "$pkg@latest"
            if ($LASTEXITCODE -ne 0) {
                throw "Failed to update npm package $pkg in $packageDir."
            }
        }

        npm outdated
    } finally {
        Pop-Location
    }
}
```

Notes:
- Upgrade only direct `dependencies` and `devDependencies` by default.
- Do not auto-upgrade `peerDependencies` unless explicitly requested.
- Keep lockfile updates generated by npm commands.
- Ignore nested lockfiles that do not have a sibling `package.json`.

## Resolve Upgrade Fallout
Fix compatibility issues directly caused by dependency upgrades:
- API or signature changes
- type errors
- build/test failures
- lint failures

Pause and ask for collaborative direction when fixes become extensive, such as broad refactors or behavior changes.

## Script Compatibility Smoke Checks (Required Before First Commit)
Dependency upgrades can break npm script contracts even when build/tests pass. Run these checks before creating the first commit on the branch:

1. If `packages/client/package.json` changed and includes script/tooling updates (especially `swagger-typescript-api`), run:
```powershell
npm --prefix .\packages\client run gen-api
```
2. Treat failures as blocking and fix before commit/push.
3. If generated drift is not intended for this dependency PR, restore generated files after the smoke check:
```powershell
git restore .\packages\client\src\models\data-contracts.ts
```
4. Record whether `gen-api` was run and passed in the PR validation section.

## Validation (Required)
Run validation per touched package and treat failures as blocking unless the user explicitly accepts known failures.

For `packages/client`:
```powershell
# Required when client script/tooling dependencies changed:
npm --prefix .\packages\client run gen-api
# Then standard validation:
npm --prefix .\packages\client run build
npm --prefix .\packages\client test
```

For `packages/integrations`:
```powershell
npm --prefix .\packages\integrations run build
npm --prefix .\packages\integrations test
```

For `packages/code-analyzer`:
```powershell
npm --prefix .\packages\code-analyzer run lint
```

Integration tests are conditional:
- Run when API behavior/contracts are changed and required secrets are available.
- If running both integration suites, run integrations package first:
```powershell
npm --prefix .\packages\integrations run integration-test --DATASET_ID=... --API_KEY=... --SERVER_URL=https://api.relewise.com
npm --prefix .\packages\client run integration-test --DATASET_ID=... --API_KEY=... --SERVER_URL=https://api.relewise.com
```
- If secrets are unavailable, report integration tests as not run.

## Commit, Push, and Pull Request
1. Confirm required script compatibility smoke checks passed (including `packages/client gen-api` when relevant).
2. Commit dependency and compatibility changes on the upgrade branch.
3. Push branch:
```powershell
git push -u origin $branchName
```
4. Create PR to `main`.

Preferred automated flow with GitHub CLI:
```powershell
$prBodyPath = ".\\upgrade-dependencies-pr-body.md"
@"
$TrelloCardUrl

## Summary
- <short summary of upgraded dependencies and compatibility fixes>

## Validation
- `packages/client`: <build/test result or not touched>
- `packages/integrations`: <build/test result or not touched>
- `packages/code-analyzer`: <lint result or not touched>
- `integration tests`: <result or not run>

## Notes
- <known issues or limitations>
"@ | Set-Content $prBodyPath

$prUrl = gh pr create --base main --head $branchName --title "chore: upgrade dependencies ($stamp)" --body-file $prBodyPath
if ($LASTEXITCODE -ne 0) { throw 'gh pr create failed.' }
Write-Host "PR URL: $prUrl"
```

Manual fallback:
```powershell
git push -u origin $branchName
Write-Host "Create PR: https://github.com/Relewise/relewise-sdk-javascript/compare/main...$branchName?expand=1"
Write-Host "PR title: chore: upgrade dependencies ($stamp)"
Write-Host "PR body file: $prBodyPath"
```

Keep the Trello URL as the first line in PR description.

## Output Expectations
Provide a final summary with:
- Trello URL used
- branch name
- upgraded npm packages grouped by manifest path
- compatibility fixes applied
- results for each validation command
- pushed branch URL
- PR URL, or exact manual fallback instructions when automated PR creation is unavailable
